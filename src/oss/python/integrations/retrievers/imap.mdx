---
title: Imap
---

# ImapRetriever

이 가이드는 IMAP [retriever](/oss/integrations/retrievers) 시작하기를 도와드립니다. `ImapRetriever`는 IMAP 서버에서 이메일을 LangChain `Document` 객체로 검색하고 가져올 수 있게 해줍니다.

## Integration 세부 정보

| Retriever | Source | Package |
| :--- | :--- | :---: |
| ImapRetriever | IMAP Email Servers | langchain-imap |

## 설정

### 설치

`ImapRetriever`는 `langchain-imap` 패키지에 포함되어 있습니다:

```bash
pip install -U langchain-imap
```

docling을 사용한 전체 문서 처리(DOCX, PPTX 등)를 위해 (테스트되지 않음):

```bash
pip install "langchain-imap[docling]"
```

### 테스트 환경 설정 (선택 사항)

테스트 목적으로 GreenMail을 사용하여 로컬 IMAP 서버를 설정할 수 있습니다:

```python
from pathlib import Path
import subprocess
import os

preload_dir = Path(os.getcwd()).parent / "tests" / "fixtures" / "preload"
log_path = Path(os.getcwd()).parent / "tests" / "container.log"

# GreenMail configuration
env_vars = {
    "GREENMAIL_OPTS": " ".join([
        "-Dgreenmail.setup.test.all",
        "-Dgreenmail.users=test:test123@localhost",
        "-Dgreenmail.users.login=local_part",
        "-Dgreenmail.preload.dir=/preload",
        "-Dgreenmail.verbose",
        "-Dgreenmail.hostname=0.0.0.0"
    ])
}

# Start GreenMail container
container_name = "langchain-imap-test"
cmd = [
    "podman", "run", "--rm", "-d",
    "--name", container_name,
    "-e", f"GREENMAIL_OPTS={env_vars['GREENMAIL_OPTS']}",
    "-v", f"{preload_dir}:/preload:ro,Z",
    "-p", "3143:3143",
    "-p", "3993:3993",
    "-p", "8080:8080",
    "--log-driver", "k8s-file",
    "--log-opt", f"path={log_path.absolute()}",
    "docker.io/greenmail/standalone:2.1.5",
]

result = subprocess.run(cmd, capture_output=True, text=True, check=True)
```

## 인스턴스화

`ImapRetriever`를 사용하려면 `ImapConfig`를 사용하여 IMAP 서버 세부 정보로 구성해야 합니다:

```python
from langchain_imap import ImapConfig, ImapRetriever

config = ImapConfig(
    host="imap.gmail.com",
    port=993,
    user="your-email@gmail.com",
    password="your-app-password",  # Use app password for Gmail
    ssl_mode="ssl",
)

retriever = ImapRetriever(config=config, k=10)
```

테스트 환경의 경우:

```python
from langchain_imap import ImapRetriever, ImapConfig

config = ImapConfig(
    host="localhost",
    port=3143,
    user="test",
    password="test123",
    ssl_mode="plain",
    verify_cert=False,
)

retriever = ImapRetriever(
    config=config,
    k=50
)
```

### 구성 옵션

- **auth_method**: 인증 방법 (기본값: "login")
- **ssl_mode**: SSL 모드 - "ssl" (기본값), "starttls", 또는 "plain"
- **verify_cert**: 자체 서명된 인증서의 경우 `False`로 설정 (프로덕션 환경에서는 권장하지 않음)
- **k**: 가져올 문서 수

## 사용법

### 기본 검색

IMAP 구문을 사용하여 이메일 검색:

```python
# Search all emails
query = 'ALL'
docs = retriever.invoke(query)

# Search by subject
query = 'SUBJECT "URGENT"'
docs = retriever.invoke(query)

# Search by sender
docs = retriever.invoke('FROM "john@example.com"')

# Search by date
docs = retriever.invoke('SENTSINCE "01-Oct-2024"')

# Combine criteria
docs = retriever.invoke('FROM "boss@company.com" SUBJECT "urgent"')

for doc in docs:
    print(doc.page_content)  # Formatted email content
```

### 첨부 파일 처리

retriever는 이메일 첨부 파일 처리를 위한 세 가지 모드를 지원합니다:

- `"names_only"` (기본값): 첨부 파일 이름만 나열
- `"text_extract"`: PDF 및 일반 텍스트 첨부 파일에서 텍스트 추출
- `"full_content"`: docling을 사용한 오피스 문서의 전체 추출 (`[docling]` extra 필요)

```python
retriever = ImapRetriever(
    config=config,
    k=10,
    attachment_mode="text_extract"
)
```

## chain 내에서 사용

다른 retriever와 마찬가지로 `ImapRetriever`는 chain을 통해 LLM 애플리케이션에 통합될 수 있습니다. 다음은 LLM을 사용하여 IMAP 쿼리를 생성하고 이메일 내용을 기반으로 질문에 답변하는 완전한 예제입니다:

```python
import os
from langchain_openai import ChatOpenAI
from langchain_core.output_parsers import StrOutputParser
from langchain_core.prompts import ChatPromptTemplate
from langchain_core.runnables import RunnablePassthrough, RunnableLambda
from langchain_imap import ImapRetriever, ImapConfig

# Setup LLM (example using OpenRouter)
llm = ChatOpenAI(
    model="google/gemini-2.5-flash-preview-09-2025",
    temperature=0,
    openai_api_key=os.getenv("OPENAI_API_KEY"),
    openai_api_base="https://openrouter.ai/api/v1"
)

# IMAP query generation prompt
query_prompt = ChatPromptTemplate.from_template(
    """Convert the following user question into an IMAP search query.

IMAP query syntax examples:
- 'FROM "john@example.com"' - emails from specific sender
- 'SUBJECT "project update"' - emails with specific subject
- 'SENTSINCE "01-Oct-2024"' - emails since specific date
- 'BODY "meeting"' - emails containing specific word in body
- 'FROM "boss@company.com" SUBJECT "urgent"' - combine criteria

IMPORTANT: Include only VALID imap command in output.
IMPORTANT: Do not include any other text in output.

User Question: {question}

IMAP Query:"""
)

# Answer generation prompt
answer_prompt = ChatPromptTemplate.from_template(
    """Answer the question based only on the context provided from emails.

Context:
{context}

Question: {question}

Answer:"""
)

# IMAP retriever configuration
config = ImapConfig(
    host="localhost",
    port=3993,
    user="test",
    password="test123",
    ssl_mode="ssl",
    auth_method="login",
    verify_cert=False,
)

retriever = ImapRetriever(
    config=config,
    k=5,
    attachment_mode="names_only"
)

def format_docs(docs):
    return "\n\n".join(doc.page_content for doc in docs)

# Create the chain
query_chain = query_prompt | llm | StrOutputParser()

def generate_imap_query(question):
    return query_chain.invoke({"question": question})

def search_emails(query):
    return retriever.invoke(query)

full_chain = (
    {
        "question": lambda x: x,
        "imap_query": lambda x: generate_imap_query(x)
    }
    | RunnablePassthrough.assign(
        context=lambda x: format_docs(search_emails(x["imap_query"]))
    )
    | answer_prompt
    | llm
    | StrOutputParser()
)

# Use the chain
TODO = full_chain.invoke("Please make a TODO based on the e-mails having URGENT in subject")
print(TODO)
```

### 테스트 환경 정리

GreenMail 테스트 컨테이너를 사용하는 경우, 테스트 후 정리하세요:

```python
cmd = ["podman", "rm", "--force", "langchain-imap-test"]
result = subprocess.run(cmd, capture_output=True, text=True, check=True)
```

## API reference

자세한 정보는 다음을 참조하세요:
- [GitHub Repository](https://github.com/jfouret/langchain-imap)
- [Package Documentation](https://github.com/jfouret/langchain-imap/blob/main/README.md)
- [Usage Examples](https://github.com/jfouret/langchain-imap/blob/main/docs/retrievers.ipynb)