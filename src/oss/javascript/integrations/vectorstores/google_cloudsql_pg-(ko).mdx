---
title: Google Cloud SQL for PostgreSQL
---

[Cloud SQL](https://cloud.google.com/sql)은 고성능, 원활한 통합, 뛰어난 확장성을 제공하는 완전 관리형 관계형 데이터베이스 서비스로, PostgreSQL과 같은 데이터베이스 엔진을 제공합니다.

이 가이드는 `PostgresVectorStore` 클래스를 사용하여 Cloud SQL for PostgreSQL에 벡터 임베딩을 저장하는 방법에 대한 간단한 개요를 제공합니다.

## 개요

### Integration 세부 정보

| Class               | Package                                    | [PY support](https://python.langchain.com/docs/integrations/vectorstores/google_cloud_sql_pg/) | Version |
| :------------------ | :----------------------------------------- | :--------------------------------------------------------------------------------------------: | :------------: |
| PostgresVectorStore | [`@langchain/google-cloud-sql-pg`](https://www.npmjs.com/package/@langchain/google-cloud-sql-pg) |                                               ✅                                               |     0.0.1      |

### 시작하기 전에

이 패키지를 사용하려면 먼저 다음 단계를 거쳐야 합니다:

1. [Cloud Platform 프로젝트를 선택하거나 생성합니다.](https://developers.google.com/workspace/guides/create-project)
2. [프로젝트에 대한 결제를 활성화합니다.](https://cloud.google.com/billing/docs/how-to/modify-project#enable_billing_for_a_project)
3. [Cloud SQL Admin API를 활성화합니다.](https://console.cloud.google.com/flows/enableapi?apiid=sqladmin.googleapis.com)
4. [인증을 설정합니다.](https://cloud.google.com/docs/authentication)
5. [CloudSQL 인스턴스를 생성합니다](https://cloud.google.com/sql/docs/postgres/connect-instance-auth-proxy#create-instance)
6. [CloudSQL 데이터베이스를 생성합니다](https://cloud.google.com/sql/docs/postgres/create-manage-databases)
7. [데이터베이스에 사용자를 추가합니다](https://cloud.google.com/sql/docs/postgres/create-manage-users)

### 인증

`gcloud auth login` 명령을 사용하여 Google Cloud 계정에 로컬로 인증합니다.

### Google Cloud 프로젝트 설정

로컬에서 Google Cloud 리소스를 활용하려면 Google Cloud 프로젝트 ID를 설정하세요:

```python
gcloud config set project YOUR-PROJECT-ID
```

프로젝트 ID를 모르는 경우 다음을 시도해보세요:

* `gcloud config list`를 실행합니다.
* `gcloud projects list`를 실행합니다.
* 지원 페이지를 참조하세요: [프로젝트 ID 찾기](https://support.google.com/googleapi/answer/7014113).

## PostgresVectorStore 인스턴스 설정하기

PostgresVectorStore 라이브러리를 사용하려면 `@langchain/google-cloud-sql-pg` 패키지를 설치한 다음 아래 단계를 따라야 합니다.

먼저 Google Cloud 계정에 로그인하고 Google Cloud 프로젝트를 기반으로 다음 환경 변수를 설정해야 합니다. 이는 PostgresEngine 인스턴스를 구성하는 방법(fromInstance, fromEngine, fromEngineArgs)에 따라 정의됩니다:

```python
PROJECT_ID="your-project-id"
REGION="your-project-region" // example: "us-central1"
INSTANCE_NAME="your-instance"
DB_NAME="your-database-name"
DB_USER="your-database-user"
PASSWORD="your-database-password"
```

### 인스턴스 설정하기

PostgresVectorStore를 인스턴스화하려면 먼저 PostgresEngine을 통해 데이터베이스 연결을 생성한 다음 벡터 저장소 테이블을 초기화하고 마지막으로 `.initialize()` 메서드를 호출하여 벡터 저장소를 인스턴스화해야 합니다.

```python
import {
  Column,
  PostgresEngine,
  PostgresEngineArgs,
  PostgresVectorStore,
  PostgresVectorStoreArgs,
  VectorStoreTableArgs,
} from "@langchain/google-cloud-sql-pg";
import { SyntheticEmbeddings } from "@langchain/core/utils/testing"; // This is used as an Embedding service
import * as dotenv from "dotenv";

dotenv.config();

const peArgs: PostgresEngineArgs = {
  user: process.env.DB_USER ?? "",
  password: process.env.PASSWORD ?? "",
};

// PostgresEngine instantiation
const engine: PostgresEngine = await PostgresEngine.fromInstance(
  process.env.PROJECT_ID ?? "",
  process.env.REGION ?? "",
  process.env.INSTANCE_NAME ?? "",
  process.env.DB_NAME ?? "",
  peArgs
);

const vectorStoreArgs: VectorStoreTableArgs = {
  metadataColumns: [new Column("page", "TEXT"), new Column("source", "TEXT")],
};

// Vector store table initilization
await engine.initVectorstoreTable("my_vector_store_table", 768, vectorStoreArgs);
const embeddingService = new SyntheticEmbeddings({ vectorSize: 768 });

const pvectorArgs: PostgresVectorStoreArgs = {
  metadataColumns: ["page", "source"],
};

// PostgresVectorStore instantiation
const vectorStore = await PostgresVectorStore.initialize(
  engine,
  embeddingService,
  "my_vector_store_table",
  pvectorArgs
);

```

## Vector Store 관리

### vector store에 Document 추가하기

Vector store에 Document를 추가하려면 id를 전달하거나 전달하지 않고 추가할 수 있습니다

```python
import { v4 as uuidv4 } from "uuid";
import type { Document } from "@langchain/core/documents";

const document1: Document = {
  pageContent: "The powerhouse of the cell is the mitochondria",
  metadata: { page: 0, source: "https://example.com" },
};

const document2: Document = {
  pageContent: "Buildings are made out of brick",
  metadata: { page: 1, source: "https://example.com" },
};

const document3: Document = {
  pageContent: "Mitochondria are made out of lipids",
  metadata: { page: 2, source: "https://example.com" },
};

const document4: Document = {
  pageContent: "The 2024 Olympics are in Paris",
  metadata: { page: 3, source: "https://example.com" },
};

const documents = [document1, document2, document3, document4];

const ids = [uuidv4(), uuidv4(), uuidv4(), uuidv4()];

await vectorStore.addDocuments(documents, { ids: ids });

```

### vector store에서 Document 삭제하기

삭제할 id 배열을 전달하여 vector store에서 하나 이상의 Document를 삭제할 수 있습니다:

```python
// deleting a document
const id1 = ids[0];
await vectorStore.delete({ ids: [id1] });

// deleting more than one document
await vectorStore.delete({ ids: ids });

```

## Document 검색

벡터 저장소가 생성되고 관련 문서가 추가되면 체인이나 에이전트를 실행하는 동안 쿼리하고 싶을 것입니다.

### 직접 쿼리하기

간단한 유사도 검색은 다음과 같이 수행할 수 있습니다:

```python
const filter = `"source" = "https://example.com"`;

const results = await vectorStore.similaritySearch("biology", 2, filter);

for (const doc of results) {
  console.log(`* ${doc.pageContent} [${JSON.stringify(doc.metadata, null)}]`);
}

```

유사도 검색을 실행하고 해당 점수를 받으려면 다음을 실행할 수 있습니다:

```python
const filter = `"source" = "https://example.com"`;
const resultsWithScores = await vectorStore.similaritySearchWithScore(
  "biology",
  2,
  filter
);

for (const [doc, score] of resultsWithScores) {
  console.log(
    `* [SIM=${score.toFixed(3)}] ${doc.pageContent} [${JSON.stringify(doc.metadata)}]`
  );
}

```

### max marginal relevance search를 사용한 쿼리

Maximal marginal relevance는 쿼리와의 유사성과 선택된 문서 간의 다양성을 최적화합니다.

```python
const options = {
  k: 4,
  filter: `"source" = 'https://example.com'`,
};

const results = await vectorStoreInstance.maxMarginalRelevanceSearch("biology", options);

for (const doc of results) {
  console.log(`* ${doc.pageContent} [${JSON.stringify(doc.metadata, null)}]`);
}

```