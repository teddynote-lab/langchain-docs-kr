---
title: Google Vertex AI Matching Engine
---

<Tip>
**호환성**

Node.js에서만 사용 가능합니다.
</Tip>

Google Vertex AI Matching Engine은 "업계 최고의 대규모
저지연 벡터 데이터베이스를 제공합니다. 이러한 벡터 데이터베이스는 일반적으로
벡터 유사도 매칭 또는 근사 최근접 이웃(ANN) 서비스로
불립니다."

## Setup

<Warning>
**이 모듈은 이미 생성된 endpoint와 배포된 index가 필요합니다.**

생성 시간이 약 1시간 정도 소요됩니다. 자세한 내용은 LangChain python
문서 [Create Index and deploy it to an Endpoint](https://python.langchain.com/docs/integrations/vectorstores/google_vertex_ai_vector_search/#deploy-index-to-the-endpoint)를 참조하세요.
</Warning>

이 코드를 실행하기 전에 Google Cloud 대시보드에서 관련 프로젝트에 대해 Vertex AI API가
활성화되어 있는지 확인하고 다음 방법 중 하나를 사용하여
Google Cloud에 인증했는지 확인해야 합니다:

- 해당 프로젝트에 권한이 있는 계정으로 로그인했습니다(`gcloud auth application-default login` 사용).
- 프로젝트에 권한이 있는 service account를 사용하는 머신에서 실행 중입니다.
- 프로젝트에 권한이 있는 service account의 자격 증명을 다운로드하고
  `GOOGLE_APPLICATION_CREDENTIALS` 환경 변수를 이 파일의 경로로 설정했습니다.

다음 명령으로 인증 라이브러리를 설치하세요:

```bash npm
npm install @langchain/community @langchain/core google-auth-library
```
Matching Engine은 실제 문서 내용을 저장하지 않고 embedding만 저장합니다. 따라서
docstore가 필요합니다. 아래 예제는 Google Cloud Storage를 사용하며 다음이 필요합니다:

```bash npm
npm install @google-cloud/storage
```
## Usage

### Engine 초기화

`MatchingEngine` 객체를 생성할 때 matching engine 구성에 대한
일부 정보가 필요합니다. Cloud Console for Matching Engine에서
이 정보를 얻을 수 있습니다:

- Index의 id
- Index Endpoint의 id

또한 document store가 필요합니다. `InMemoryDocstore`는 초기
테스트에는 괜찮지만, 더 영구적으로 저장하려면
[GoogleCloudStorageDocstore](https://api.js.langchain.com/classes/_langchain_community.stores_doc_gcs.GoogleCloudStorageDocstore.html)와 같은 것을 사용하는 것이 좋습니다.

```typescript
import { MatchingEngine } from "@langchain/community/vectorstores/googlevertexai";
import { Document } from "@langchain/classic/document";
import { SyntheticEmbeddings } from "@langchain/classic/embeddings/fake";
import { GoogleCloudStorageDocstore } from "@langchain/community/stores/doc/gcs";

const embeddings = new SyntheticEmbeddings({
  vectorSize: Number.parseInt(
    process.env.SYNTHETIC_EMBEDDINGS_VECTOR_SIZE ?? "768",
    10
  ),
});

const store = new GoogleCloudStorageDocstore({
  bucket: process.env.GOOGLE_CLOUD_STORAGE_BUCKET!,
});

const config = {
  index: process.env.GOOGLE_VERTEXAI_MATCHINGENGINE_INDEX!,
  indexEndpoint: process.env.GOOGLE_VERTEXAI_MATCHINGENGINE_INDEXENDPOINT!,
  apiVersion: "v1beta1",
  docstore: store,
};

const engine = new MatchingEngine(embeddings, config);
```
### 문서 추가

```typescript
const doc = new Document({ pageContent: "this" });
await engine.addDocuments([doc]);
```
문서의 모든 metadata는 쿼리 중에 필터링하는 데 사용할 수 있는
Matching Engine "allow list" 값으로 변환됩니다.

```typescript
const documents = [
  new Document({
    pageContent: "this apple",
    metadata: {
      color: "red",
      category: "edible",
    },
  }),
  new Document({
    pageContent: "this blueberry",
    metadata: {
      color: "blue",
      category: "edible",
    },
  }),
  new Document({
    pageContent: "this firetruck",
    metadata: {
      color: "red",
      category: "machine",
    },
  }),
];

// Add all our documents
await engine.addDocuments(documents);
```
문서에는 "id" 매개변수도 사용 가능한 것으로 가정합니다. 이것이
설정되지 않은 경우 ID가 할당되어 Document의 일부로 반환됩니다.

### 문서 쿼리

모든 결과를 반환하는 간단한 k-nearest-neighbor 검색은
표준 메서드 중 하나를 사용하여 수행됩니다:

```typescript
const results = await engine.similaritySearch("this");
```
### filter / restriction을 사용한 문서 쿼리

문서에 설정된 metadata를 기반으로 반환되는 문서를 제한할 수 있습니다.
따라서 빨간색인 결과만 제한하려면 다음과 같이 할 수 있습니다:

```typescript
import { Restriction } from `@langchain/community/vectorstores/googlevertexai`;

const redFilter: Restriction[] = [
  {
    namespace: "color",
    allowList: ["red"],
  },
];
const redResults = await engine.similaritySearch("this", 4, redFilter);
```
빨간색이지만 먹을 수 없는 것과 같이 더 복잡한 작업을 수행하려면:

```typescript
const filter: Restriction[] = [
  {
    namespace: "color",
    allowList: ["red"],
  },
  {
    namespace: "category",
    denyList: ["edible"],
  },
];
const results = await engine.similaritySearch("this", 4, filter);
```
### 문서 삭제

문서 삭제는 ID를 사용하여 수행됩니다.

```typescript
import { IdDocument } from `@langchain/community/vectorstores/googlevertexai`;

const oldResults: IdDocument[] = await engine.similaritySearch("this", 10);
const oldIds = oldResults.map( doc => doc.id! );
await engine.delete({ids: oldIds});
```

## Related

- Vector store [개념 가이드](/oss/integrations/vectorstores)
- Vector store [사용 방법 가이드](/oss/integrations/vectorstores)
```